From 4a7c602356b9afbbcb5d4d389749c40bbf11a315 Mon Sep 17 00:00:00 2001
From: mw-agadkari <agadkari@mathworks.com>
Date: Thu, 12 Dec 2024 06:55:14 -0500
Subject: [PATCH] drivers/misc/mathworks: Update get_irq API and reset TLAST at
 pre-enable instead of resetting full ip-core

---
 drivers/misc/mathworks/mw_stream_iio_channel.c | 13 ++++---------
 1 file changed, 4 insertions(+), 9 deletions(-)

diff --git a/drivers/misc/mathworks/mw_stream_iio_channel.c b/drivers/misc/mathworks/mw_stream_iio_channel.c
index 339ab0bdd87f..7af3b63ec133 100644
--- a/drivers/misc/mathworks/mw_stream_iio_channel.c
+++ b/drivers/misc/mathworks/mw_stream_iio_channel.c
@@ -93,28 +93,23 @@ static int mw_stream_iio_buffer_preenable(struct iio_dev *indio_dev)
 {
 	struct mw_stream_iio_chandev *mwchan = iio_priv(indio_dev);
 
-	dev_dbg(&mwchan->dev, "buffer preenable\n");
-
+	dev_dbg(&mwchan->dev, "Buffer preenable\n");
 	switch(mwchan->reset_ip_mode) {
 		case MW_STREAM_RESET_IP_MODE_ENABLE:
 		case MW_STREAM_RESET_IP_MODE_ALL:
-			/* reset the ip core */
-			dev_dbg(&mwchan->dev, "resetting IP Core\n");
+			dev_dbg(&mwchan->dev, "Resetting IP Core\n");
 			mw_ip_reset(mwchan->mwdev);
 			break;
 		default:
-			/* Do Nothing */
 			break;
 	}
 	if (mwchan->tlast_cntr_addr >= 0 && mwchan->tlast_mode == MW_STREAM_TLAST_MODE_AUTO) {
 		if(mwchan->reset_tlast_mode == MW_STREAM_TLAST_MODE_PREBUFFER) {
-			/* reset the IP core (TODO: only reset the TLAST register)*/
-			mw_ip_reset(mwchan->mwdev);
+			dev_dbg(&mwchan->dev, "Resetting TLAST register \n");
+			mw_ip_write32(mwchan->mwdev->mw_ip_info, mwchan->tlast_cntr_addr, 0x0);
 		}
-		/* Set the TLAST count */
 		mw_ip_write32(mwchan->mwdev->mw_ip_info, mwchan->tlast_cntr_addr, indio_dev->buffer->length);
 	}
-
 	return 0;
 }
 static int mw_stream_iio_buffer_postenable(struct iio_dev *indio_dev)
-- 
2.25.1

